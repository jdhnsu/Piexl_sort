<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡åˆ†ç±»å®¢æˆ·ç«¯</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f6fa;
            margin: 0;
            padding: 10px;
            color: #333;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 5px;
        }
        header {
            text-align: center;
            margin-bottom: 15px;
        }
        h1 {
            color: #6750A4;
            margin: 10px 0;
            font-size: 24px;
        }
        .connection-form {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 12px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        button {
            background-color: #6750A4;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #5a4a8f;
        }
        .image-container {
            text-align: center;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
            background-color: #181A20;
            border-radius: 6px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            height: 75vh;
        }
        #processed-image {
            max-width: 95%;
            max-height: 95%;
            border: none;
            border-radius: 0;
            cursor: move;
            user-select: none;
            box-shadow: none;
            object-fit: contain;
        }
        /* æ·»åŠ å‰æ™¯å æ¯”æ˜¾ç¤ºæ ·å¼ */
        .foreground-ratio {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 16px;
            z-index: 10;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .category-btn {
            background-color: #353945;
            padding: 8px 16px;
            font-size: 14px;
        }
        .category-btn:hover {
            background-color: #2a2d36;
        }
        .progress-info {
            text-align: center;
            margin: 15px 0;
            font-size: 16px;
        }
        .hidden {
            display: none;
        }
        .status-message {
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
            text-align: center;
        }
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
        .warning {
            background-color: #fff8e1;
            color: #f57f17;
        }
        /* æ·»åŠ æ§åˆ¶æ æ ·å¼ */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 0 5px;
        }
        /* æ·»åŠ ç¼©æ”¾æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .zoom-controls {
            display: flex;
            gap: 4px;
        }
        .zoom-btn {
            width: 32px;
            height: 32px;
            font-size: 14px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #353945;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .zoom-btn:hover {
            background-color: #2a2d36;
        }
        /* æ·»åŠ å¸ƒå±€åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .layout-controls {
            display: flex;
            gap: 4px;
        }
        .layout-btn {
            background-color: #353945;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .layout-btn:hover {
            background-color: #2a2d36;
        }
        .layout-btn.active {
            background-color: #6750A4;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å›¾ç‰‡åˆ†ç±»å®¢æˆ·ç«¯</h1>
        </header>
        
        <div id="connection-section">
            <div class="connection-form">
                <div class="form-group">
                    <label for="server-url">æœåŠ¡å™¨åœ°å€:</label>
                    <input type="text" id="server-url" placeholder="ä¾‹å¦‚: http://localhost:5000">
                </div>
                <div class="form-group">
                    <label for="token">ä¸ªäººToken:</label>
                    <input type="text" id="token" placeholder="è¯·è¾“å…¥æ‚¨çš„Token">
                </div>
                <button id="connect-btn">è¿æ¥æœåŠ¡å™¨</button>
            </div>
        </div>
        
        <div id="task-section" class="hidden">
            <div class="progress-info">
                <p>å½“å‰è¿›åº¦: <span id="current-index">0</span>/<span id="total-count">0</span></p>
            </div>
            
            <div class="current-image-info" style="text-align: center; margin: 5px 0; font-size: 14px; color: #666;">
                <p>å½“å‰æ–‡ä»¶: <span id="current-image-name">æ— </span></p>
            </div>
            
            <div class="controls-bar">
                <div class="layout-controls">
                    <button id="grid-layout-btn" class="layout-btn">å®«æ ¼å¸ƒå±€</button>
                    <button id="row-layout-btn" class="layout-btn active">æ¨ªå‘å¸ƒå±€</button>
                </div>
                
                <div class="zoom-controls">
                    <button id="zoom-in-btn" class="zoom-btn">+</button>
                    <button id="zoom-out-btn" class="zoom-btn">-</button>
                    <button id="reset-view-btn" class="zoom-btn">â†º</button>
                </div>
            </div>
            
            <div class="image-container">
                <div id="foreground-ratio" class="foreground-ratio" style="display: none;"></div>
                <img id="processed-image" alt="å¤„ç†åçš„å›¾ç‰‡">
            </div>
            
            <div class="controls">
                <button class="category-btn" data-category="æ¸…æ´—">æ¸…æ´—</button>
                <button class="category-btn" data-category="ä¿ç•™">ä¿ç•™</button>
                <button class="category-btn" data-category="é˜´å½±">é˜´å½±</button>
                <button class="category-btn" data-category="é®æŒ¡">é®æŒ¡</button>
                <button id="undo-btn" class="category-btn" style="background-color: #6750A4;">æ’¤é”€</button>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button id="submit-btn">æäº¤åˆ†ç±»ç»“æœ</button>
            </div>
            
            <!-- è®¾ç½®æŒ‰é’®æ”¾åœ¨å³ä¸‹è§’ -->
            <div style="position: fixed; bottom: 20px; right: 20px;">
                <button id="settings-btn" style="background-color: #353945; padding: 8px 12px; border-radius: 50%; width: 40px; height: 40px; font-size: 16px; display: flex; align-items: center; justify-content: center;">âš™</button>
            </div>
        </div>
        
        <div id="status-message" class="status-message hidden"></div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentImage = null;
        let currentIndex = 0;
        let totalCount = 0;
        // æ·»åŠ ç¼©æ”¾å’Œæ‹–æ‹½ç›¸å…³å˜é‡
        let scale = 1;
        let minScale = 0.1;
        let maxScale = 5;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let startOffsetX = 0;
        let startOffsetY = 0;
        // æ·»åŠ å¸ƒå±€æ¨¡å¼å˜é‡
        let layoutMode = "row"; // "grid" æˆ– "row"
        // æ·»åŠ å†å²è®°å½•å˜é‡
        let history = [];
        const maxHistoryLength = 3;
        
        // DOMå…ƒç´ 
        const connectionSection = document.getElementById('connection-section');
        const taskSection = document.getElementById('task-section');
        const serverUrlInput = document.getElementById('server-url');
        const tokenInput = document.getElementById('token');
        const connectBtn = document.getElementById('connect-btn');
        const processedImage = document.getElementById('processed-image');
        const currentIndexSpan = document.getElementById('current-index');
        const totalCountSpan = document.getElementById('total-count');
        const submitBtn = document.getElementById('submit-btn');
        const undoBtn = document.getElementById('undo-btn');
        const statusMessage = document.getElementById('status-message');
        const settingsBtn = document.getElementById('settings-btn');
        // è·å–æ–°å¢çš„æ§åˆ¶æŒ‰é’®
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const resetViewBtn = document.getElementById('reset-view-btn');
        const gridLayoutBtn = document.getElementById('grid-layout-btn');
        const rowLayoutBtn = document.getElementById('row-layout-btn');
        
        // äº‹ä»¶ç›‘å¬å™¨
        connectBtn.addEventListener('click', connectToServer);
        submitBtn.addEventListener('click', submitClassification);
        document.getElementById('undo-btn').addEventListener('click', undo);
        settingsBtn.addEventListener('click', openSettings);
        
        // åˆå§‹åŒ–åˆ†ç±»æŒ‰é’®
        updateCategoryButtons();
        
        // ä¸ºæ‰€æœ‰åˆ†ç±»æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        /* document.querySelectorAll('.category-btn:not(#undo-btn)').forEach(button => {
            button.addEventListener('click', function() {
                const category = this.getAttribute('data-category');
                classifyCurrentImage(category);
            });
        }); */
        
        // æ·»åŠ ç¼©æ”¾å’Œæ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨
        zoomInBtn.addEventListener('click', zoomIn);
        zoomOutBtn.addEventListener('click', zoomOut);
        resetViewBtn.addEventListener('click', resetView);
        
        // æ·»åŠ å¸ƒå±€åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
        gridLayoutBtn.addEventListener('click', () => switchLayout('grid'));
        rowLayoutBtn.addEventListener('click', () => switchLayout('row'));
        
        // å›¾ç‰‡æ‹–æ‹½äº‹ä»¶
        processedImage.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', endDrag);
        
        // é¼ æ ‡æ»šè½®ç¼©æ”¾
        processedImage.addEventListener('wheel', handleWheel);
        
        // é”®ç›˜å¿«æ·é”®
        /* function handleKeyDown(e) {
            // åªåœ¨ä»»åŠ¡ç•Œé¢å¯ç”¨å¿«æ·é”®
            if (taskSection.classList.contains('hidden')) return;
            
            switch(e.key) {
                case '+':
                case '=':
                    if (e.ctrlKey) zoomIn();
                    break;
                case '-':
                    if (e.ctrlKey) zoomOut();
                    break;
                case '0':
                    if (e.ctrlKey) resetView();
                    break;
                case 'z':
                case 'Z':
                    if (e.ctrlKey) undo();
                    break;
                case 'ArrowLeft':
                    offsetX += 40;
                    applyTransform();
                    break;
                case 'ArrowRight':
                    offsetX -= 40;
                    applyTransform();
                    break;
                case 'ArrowUp':
                    offsetY += 40;
                    applyTransform();
                    break;
                case 'ArrowDown':
                    offsetY -= 40;
                    applyTransform();
                    break;
            }
        } */
        
        // çª—å£å¤§å°è°ƒæ•´å¤„ç†
        window.addEventListener('resize', handleResize);
        
        // åŒå‡»é‡ç½®è§†å›¾
        processedImage.addEventListener('dblclick', resetView);
        
        // è¿æ¥æœåŠ¡å™¨
        function connectToServer() {
            const serverUrl = serverUrlInput.value.trim();
            const token = tokenInput.value.trim();
            
            if (!serverUrl || !token) {
                showStatus('æœåŠ¡å™¨åœ°å€å’ŒTokenä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            fetch('/connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    server_url: serverUrl,
                    token: token
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    showStatus('è¿æ¥æˆåŠŸï¼æ­£åœ¨åŠ è½½ä»»åŠ¡...', 'success');
                    connectionSection.classList.add('hidden');
                    taskSection.classList.remove('hidden');
                    // å¯ç”¨åˆ†ç±»æŒ‰é’®
                    enableClassificationButtons();
                    loadNextImage();
                } else {
                    showStatus(data.message, 'error');
                }
            })
            .catch(error => {
                showStatus('è¿æ¥æœåŠ¡å™¨æ—¶å‡ºé”™: ' + error.message, 'error');
            });
        }
        
        // åŠ è½½ä¸‹ä¸€å¼ å›¾ç‰‡
        function loadNextImage() {
            fetch('/get_current_image')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    currentImage = data.image;
                    currentIndex = data.index;
                    totalCount = data.total;
                    
                    currentIndexSpan.textContent = currentIndex + 1;
                    totalCountSpan.textContent = totalCount;
                    
                    // æ›´æ–°å½“å‰æ–‡ä»¶åæ˜¾ç¤º
                    document.getElementById('current-image-name').textContent = currentImage;
                    
                    // é‡ç½®è§†å›¾çŠ¶æ€
                    resetView();
                    
                    // å¤„ç†å¹¶æ˜¾ç¤ºå›¾ç‰‡
                    processAndDisplayImage(currentImage);
                } else if (data.status === 'completed') {
                    // æ˜¾ç¤ºå®Œæˆæç¤ºå¹¶ç¦ç”¨åˆ†ç±»æŒ‰é’®
                    showStatus('ğŸ‰ æ‰€æœ‰å›¾ç‰‡å·²åˆ†ç±»å®Œæˆï¼è¯·æäº¤åˆ†ç±»ç»“æœã€‚', 'success');
                    disableClassificationButtons();
                    // æ›´æ–°å½“å‰æ–‡ä»¶åæ˜¾ç¤º
                    document.getElementById('current-image-name').textContent = 'å·²å®Œæˆæ‰€æœ‰å›¾ç‰‡åˆ†ç±»';
                } else {
                    showStatus(data.message, 'error');
                }
            })
            .catch(error => {
                showStatus('åŠ è½½å›¾ç‰‡æ—¶å‡ºé”™: ' + error.message, 'error');
            });
        }
        
        // å¤„ç†å¹¶æ˜¾ç¤ºå›¾ç‰‡
        function processAndDisplayImage(imageName) {
            fetch(`/process_image/${encodeURIComponent(imageName)}?layout=${layoutMode}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    processedImage.src = 'data:image/png;base64,' + data.image_data;
                    // å›¾ç‰‡åŠ è½½å®Œæˆååº”ç”¨å˜æ¢
                    processedImage.onload = applyTransform;
                    
                    // æ˜¾ç¤ºå‰æ™¯å æ¯”
                    if (data.foreground_ratio !== undefined) {
                        const ratioElement = document.getElementById('foreground-ratio');
                        ratioElement.textContent = `å‰æ™¯å æ¯”: ${(data.foreground_ratio * 100).toFixed(2)}%`;
                        ratioElement.style.display = 'block';
                    }
                } else {
                    showStatus(data.message, 'error');
                }
            })
            .catch(error => {
                showStatus('å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™: ' + error.message, 'error');
            });
        }
        
        // åˆ†ç±»å½“å‰å›¾ç‰‡
        function classifyCurrentImage(category) {
            if (!currentImage) {
                showStatus('æ²¡æœ‰å¯åˆ†ç±»çš„å›¾ç‰‡', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»å®Œæˆæ‰€æœ‰å›¾ç‰‡åˆ†ç±»
            if (currentIndex >= totalCount) {
                showStatus('ğŸ‰ æ‰€æœ‰å›¾ç‰‡å·²åˆ†ç±»å®Œæˆï¼è¯·æäº¤åˆ†ç±»ç»“æœã€‚', 'warning');
                return;
            }
            
            // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²è®°å½•
            saveToHistory(currentImage, category);
            
            fetch('/classify_image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    image_name: currentImage,
                    category: category
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    showStatus(`å›¾ç‰‡å·²åˆ†ç±»ä¸º"${category}"`, 'success');
                    // åŠ è½½ä¸‹ä¸€å¼ å›¾ç‰‡ï¼ˆä¿æŒå½“å‰çš„ç¼©æ”¾å’Œåç§»çŠ¶æ€ï¼‰
                    loadNextImage();
                } else {
                    showStatus(data.message, 'error');
                }
            })
            .catch(error => {
                showStatus('åˆ†ç±»å›¾ç‰‡æ—¶å‡ºé”™: ' + error.message, 'error');
            });
        }
        
        // æäº¤åˆ†ç±»ç»“æœ
        function submitClassification() {
            if (currentIndex < totalCount) {
                if (confirm('è¿˜æœ‰æœªå¤„ç†çš„å›¾ç‰‡ï¼Œç¡®å®šè¦æäº¤å½“å‰åˆ†ç±»ç»“æœå—ï¼Ÿ')) {
                    doSubmit();
                }
            } else {
                doSubmit();
            }
        }
        
        // ä¿å­˜åˆ°å†å²è®°å½•
        function saveToHistory(imageName, category) {
            // æ·»åŠ åˆ°å†å²è®°å½•å¼€å¤´
            history.unshift({
                image: imageName,
                category: category,
                index: currentIndex
            });
            
            // é™åˆ¶å†å²è®°å½•é•¿åº¦ä¸º3
            if (history.length > maxHistoryLength) {
                history.pop();
            }
        }
        
        // æ’¤é”€åŠŸèƒ½
        function undo() {
            // æ£€æŸ¥æ˜¯å¦å·²ç»å®Œæˆæ‰€æœ‰å›¾ç‰‡åˆ†ç±»
            if (currentIndex >= totalCount && history.length === 0) {
                // å³ä½¿åœ¨å®ŒæˆçŠ¶æ€ä¸‹ä¹Ÿå…è®¸æ’¤é”€æ“ä½œ
                // æ£€æŸ¥æœ¬åœ°åˆ†ç±»æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                fetch('/undo_from_local_file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        showStatus(`å·²ä»æœ¬åœ°æ–‡ä»¶æ’¤é”€åˆ†ç±»æ“ä½œ`, 'success');
                        // æ›´æ–°ç´¢å¼•å¹¶é‡æ–°åŠ è½½å›¾ç‰‡
                        currentIndex = data.new_index;
                        // å¯ç”¨åˆ†ç±»æŒ‰é’®ï¼ˆåœ¨æ’¤é”€æ“ä½œåï¼‰
                        enableClassificationButtons();
                        loadNextImage();
                    } else {
                        showStatus(data.message, 'error');
                    }
                })
                .catch(error => {
                    showStatus('ä»æœ¬åœ°æ–‡ä»¶æ’¤é”€æ“ä½œæ—¶å‡ºé”™: ' + error.message, 'error');
                });
                return;
            }
            
            // é¦–å…ˆå°è¯•ä»å†…å­˜å†å²è®°å½•ä¸­æ’¤é”€
            if (history.length > 0) {
                // ä»å†å²è®°å½•ä¸­å–å‡ºæœ€åä¸€é¡¹
                const lastAction = history.shift();
                
                fetch('/undo_classification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_name: lastAction.image,
                        category: lastAction.category,
                        from_memory: true
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        showStatus(`å·²æ’¤é”€å¯¹"${lastAction.image}"çš„åˆ†ç±»æ“ä½œ`, 'success');
                        // é‡æ–°åŠ è½½å½“å‰å›¾ç‰‡
                        currentIndex = lastAction.index;
                        // å¯ç”¨åˆ†ç±»æŒ‰é’®ï¼ˆåœ¨æ’¤é”€æ“ä½œåï¼‰
                        enableClassificationButtons();
                        loadNextImage();
                    } else {
                        showStatus(data.message, 'error');
                        // æ’¤é”€å¤±è´¥æ—¶ï¼Œå°†æ“ä½œæ”¾å›å†å²è®°å½•
                        history.unshift(lastAction);
                    }
                })
                .catch(error => {
                    showStatus('æ’¤é”€æ“ä½œæ—¶å‡ºé”™: ' + error.message, 'error');
                    // æ’¤é”€å¤±è´¥æ—¶ï¼Œå°†æ“ä½œæ”¾å›å†å²è®°å½•
                    history.unshift(lastAction);
                });
            } else {
                // å¦‚æœå†…å­˜ä¸­æ²¡æœ‰å†å²è®°å½•ï¼Œåˆ™ä»æœ¬åœ°åˆ†ç±»æ–‡ä»¶æ’¤é”€
                fetch('/undo_from_local_file', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        showStatus(`å·²ä»æœ¬åœ°æ–‡ä»¶æ’¤é”€åˆ†ç±»æ“ä½œ`, 'success');
                        // æ›´æ–°ç´¢å¼•å¹¶é‡æ–°åŠ è½½å›¾ç‰‡
                        currentIndex = data.new_index;
                        // å¯ç”¨åˆ†ç±»æŒ‰é’®ï¼ˆåœ¨æ’¤é”€æ“ä½œåï¼‰
                        enableClassificationButtons();
                        loadNextImage();
                    } else {
                        showStatus(data.message, 'error');
                    }
                })
                .catch(error => {
                    showStatus('ä»æœ¬åœ°æ–‡ä»¶æ’¤é”€æ“ä½œæ—¶å‡ºé”™: ' + error.message, 'error');
                });
            }
        }
        
        function doSubmit() {
            fetch('/submit_classification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    showStatus(data.message, 'success');
                } else {
                    showStatus(data.message, 'error');
                }
            })
            .catch(error => {
                showStatus('æäº¤åˆ†ç±»ç»“æœæ—¶å‡ºé”™: ' + error.message, 'error');
            });
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message ' + type;
            statusMessage.classList.remove('hidden');
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 3000);
            }
        }
        
        // ç¼©æ”¾åŠŸèƒ½
        function zoomIn() {
            scale = Math.min(maxScale, scale * 1.2);
            applyTransform();
        }
        
        function zoomOut() {
            scale = Math.max(minScale, scale / 1.2);
            applyTransform();
        }
        
        function resetView() {
            scale = 1;
            offsetX = 0;
            offsetY = 0;
            applyTransform();
            
            // éšè—å‰æ™¯å æ¯”æ˜¾ç¤º
            const ratioElement = document.getElementById('foreground-ratio');
            if (ratioElement) {
                ratioElement.style.display = 'none';
            }
        }
        
        // æ‹–æ‹½åŠŸèƒ½
        function startDrag(e) {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            startOffsetX = offsetX;
            startOffsetY = offsetY;
            processedImage.style.cursor = 'grabbing';
            e.preventDefault();
        }
        
        function drag(e) {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            offsetX = startOffsetX + dx;
            offsetY = startOffsetY + dy;
            applyTransform();
        }
        
        function endDrag() {
            isDragging = false;
            processedImage.style.cursor = 'move';
        }
        
        // é¼ æ ‡æ»šè½®ç¼©æ”¾
        function handleWheel(e) {
            e.preventDefault();
            const rect = processedImage.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const zoomIntensity = 0.1;
            const wheel = e.deltaY < 0 ? 1 : -1;
            const zoom = Math.exp(wheel * zoomIntensity);
            
            // é™åˆ¶ç¼©æ”¾èŒƒå›´
            const newScale = Math.min(maxScale, Math.max(minScale, scale * zoom));
            
            // è°ƒæ•´åç§»é‡ä»¥å®ç°é¼ æ ‡ä½ç½®ç¼©æ”¾
            offsetX = x - (x - offsetX) * (newScale / scale);
            offsetY = y - (y - offsetY) * (newScale / scale);
            
            scale = newScale;
            applyTransform();
        }
        
        // åº”ç”¨å˜æ¢ï¼ˆç¼©æ”¾å’Œå¹³ç§»ï¼‰
        function applyTransform() {
            processedImage.style.transform = `scale(${scale}) translate(${offsetX/scale}px, ${offsetY/scale}px)`;
            processedImage.style.transformOrigin = 'center center';
        }
        
        // é”®ç›˜å¿«æ·é”®
        function handleKeyDown(e) {
            // åªåœ¨ä»»åŠ¡ç•Œé¢å¯ç”¨å¿«æ·é”®
            if (taskSection.classList.contains('hidden')) return;
            
            switch(e.key) {
                case '+':
                case '=':
                    if (e.ctrlKey) zoomIn();
                    break;
                case '-':
                    if (e.ctrlKey) zoomOut();
                    break;
                case '0':
                    if (e.ctrlKey) resetView();
                    break;
                case 'z':
                case 'Z':
                    if (e.ctrlKey) undo();
                    break;
                case 'ArrowLeft':
                    offsetX += 40;
                    applyTransform();
                    break;
                case 'ArrowRight':
                    offsetX -= 40;
                    applyTransform();
                    break;
                case 'ArrowUp':
                    offsetY += 40;
                    applyTransform();
                    break;
                case 'ArrowDown':
                    offsetY -= 40;
                    applyTransform();
                    break;
            }
        }
        
        // çª—å£å¤§å°è°ƒæ•´å¤„ç†
        function handleResize() {
            if (!taskSection.classList.contains('hidden')) {
                // ç®€å•çš„é‡ç½®è§†å›¾ä»¥é€‚åº”æ–°å°ºå¯¸
                applyTransform();
            }
        }
        
        // ç¦ç”¨åˆ†ç±»æŒ‰é’®
        function disableClassificationButtons() {
            // ç¦ç”¨æ‰€æœ‰åˆ†ç±»æŒ‰é’®ï¼ˆé™¤äº†æ’¤é”€æŒ‰é’®ï¼‰
            document.querySelectorAll('.category-btn:not(#undo-btn)').forEach(button => {
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
            });
        }
        
        // å¯ç”¨åˆ†ç±»æŒ‰é’®
        function enableClassificationButtons() {
            // å¯ç”¨æ‰€æœ‰åˆ†ç±»æŒ‰é’®ï¼ˆé™¤äº†æ’¤é”€æŒ‰é’®ï¼‰
            document.querySelectorAll('.category-btn:not(#undo-btn)').forEach(button => {
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
            });
        }
        
        // å¸ƒå±€åˆ‡æ¢åŠŸèƒ½
        function switchLayout(mode) {
            layoutMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            if (mode === 'grid') {
                gridLayoutBtn.classList.add('active');
                rowLayoutBtn.classList.remove('active');
            } else {
                gridLayoutBtn.classList.remove('active');
                rowLayoutBtn.classList.add('active');
            }
            
            // é‡æ–°åŠ è½½å½“å‰å›¾ç‰‡ä»¥åº”ç”¨æ–°å¸ƒå±€
            if (currentImage) {
                processAndDisplayImage(currentImage);
            }
        }
        
        // è®¾ç½®åŠŸèƒ½ç›¸å…³å‡½æ•°
        function openSettings() {
            // è·å–å½“å‰è®¾ç½®
            const categoriesSettings = getCategoriesSettings();
            
            let settingsHTML = '<div id="settings-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">';
            settingsHTML += '<div style="background-color: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 500px;">';
            settingsHTML += '<h3 style="margin-top: 0;">åˆ†ç±»è®¾ç½®</h3>';
            settingsHTML += '<div id="category-settings">';
            
            // ä¸ºæ¯ä¸ªåˆ†ç±»æ·»åŠ è®¾ç½®è¡Œ
            categoriesSettings.forEach((categorySetting, index) => {
                settingsHTML += `<div style="display: flex; margin-bottom: 10px; align-items: center;">`;
                settingsHTML += `<input type="checkbox" class="category-enable" data-index="${index}" ${categorySetting.enabled ? 'checked' : ''} style="margin-right: 10px;">`;
                settingsHTML += `<label style="width: 100px;">åˆ†ç±»åç§°:</label>`;
                settingsHTML += `<input type="text" class="category-name" data-index="${index}" value="${categorySetting.name}" style="flex: 1; margin: 0 10px; padding: 5px;">`;
                settingsHTML += `<label style="width: 60px;">å¿«æ·é”®:</label>`;
                settingsHTML += `<select class="category-shortcut" data-index="${index}" style="flex: 1; margin: 0 10px; padding: 5px;">`;
                
                // æ·»åŠ æ•°å­—1-9ä½œä¸ºå¿«æ·é”®é€‰é¡¹
                for (let i = 1; i <= 9; i++) {
                    const selected = (i == categorySetting.shortcut) ? 'selected' : '';
                    settingsHTML += `<option value="${i}" ${selected}>${i}</option>`;
                }
                
                settingsHTML += `</select>`;
                settingsHTML += `</div>`;
            });
            
            settingsHTML += '</div>';
            settingsHTML += '<div style="display: flex; justify-content: flex-end; margin-top: 20px;">';
            settingsHTML += '<button id="cancel-settings" style="margin-right: 10px; background-color: #ccc;">å–æ¶ˆ</button>';
            settingsHTML += '<button id="save-settings" style="background-color: #6750A4; color: white;">ä¿å­˜</button>';
            settingsHTML += '</div>';
            settingsHTML += '</div>';
            settingsHTML += '</div>';
            
            // æ·»åŠ åˆ°body
            document.body.insertAdjacentHTML('beforeend', settingsHTML);
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('cancel-settings').addEventListener('click', closeSettings);
            document.getElementById('save-settings').addEventListener('click', saveSettings);
        }
        
        function closeSettings() {
            const modal = document.getElementById('settings-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function saveSettings() {
            const enables = document.querySelectorAll('.category-enable');
            const names = document.querySelectorAll('.category-name');
            const shortcuts = document.querySelectorAll('.category-shortcut');
            
            const categoriesSettings = [];
            const categoryShortcuts = {};
            
            names.forEach((input, index) => {
                const enabled = enables[index].checked;
                const name = input.value.trim();
                const shortcut = shortcuts[index].value;
                
                if (name) {
                    const categorySetting = {
                        name: name,
                        enabled: enabled,
                        shortcut: parseInt(shortcut)
                    };
                    categoriesSettings.push(categorySetting);
                    
                    if (enabled) {
                        categoryShortcuts[name] = parseInt(shortcut);
                    }
                }
            });
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('categoriesSettings', JSON.stringify(categoriesSettings));
            localStorage.setItem('categoryShortcuts', JSON.stringify(categoryShortcuts));
            
            // æ›´æ–°ç•Œé¢
            updateCategoryButtons();
            
            // å…³é—­è®¾ç½®çª—å£
            closeSettings();
            
            showStatus('è®¾ç½®å·²ä¿å­˜', 'success');
        }
        
        // è·å–åˆ†ç±»è®¾ç½®
        function getCategoriesSettings() {
            const savedSettings = localStorage.getItem('categoriesSettings');
            if (savedSettings) {
                return JSON.parse(savedSettings);
            }
            
            // é»˜è®¤8ä¸ªåˆ†ç±»ï¼Œå‰4ä¸ªå¯ç”¨
            return [
                { name: 'æ¸…æ´—', enabled: true, shortcut: 1 },
                { name: 'ä¿ç•™', enabled: true, shortcut: 2 },
                { name: 'é˜´å½±', enabled: true, shortcut: 3 },
                { name: 'é®æŒ¡', enabled: true, shortcut: 4 },
                { name: 'æ¨¡ç³Š', enabled: false, shortcut: 5 },
                { name: 'é‡å¤', enabled: false, shortcut: 6 },
                { name: 'å…¶ä»–', enabled: false, shortcut: 7 },
                { name: 'å¾…å®š', enabled: false, shortcut: 8 }
            ];
        }
        
        // è·å–å¿«æ·é”®è®¾ç½®
        function getShortcuts() {
            const savedShortcuts = localStorage.getItem('categoryShortcuts');
            if (savedShortcuts) {
                const shortcuts = JSON.parse(savedShortcuts);
                const categoriesSettings = getCategoriesSettings();
                const enabledCategories = categoriesSettings.filter(cat => cat.enabled);
                return enabledCategories.map(category => shortcuts[category.name] || 0);
            }
            
            // é»˜è®¤å¿«æ·é”®
            return [1, 2, 3, 4];
        }
        
        // æ›´æ–°åˆ†ç±»æŒ‰é’®
        function updateCategoryButtons() {
            const categoriesSettings = getCategoriesSettings();
            const enabledCategories = categoriesSettings.filter(cat => cat.enabled);
            const shortcuts = getShortcuts();
            
            // æ¸…é™¤ç°æœ‰çš„åˆ†ç±»æŒ‰é’®ï¼ˆé™¤äº†æ’¤é”€æŒ‰é’®ï¼‰
            const controlsDiv = document.querySelector('.controls');
            const undoBtn = document.getElementById('undo-btn');
            
            // ä¿ç•™æ’¤é”€æŒ‰é’®
            const undoButton = undoBtn ? undoBtn.parentNode.removeChild(undoBtn) : null;
            
            // æ¸…ç©ºcontrols div
            controlsDiv.innerHTML = '';
            
            // é‡æ–°åˆ›å»ºåˆ†ç±»æŒ‰é’®
            enabledCategories.forEach((categorySetting, index) => {
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.setAttribute('data-category', categorySetting.name);
                button.textContent = `${categorySetting.name} (${categorySetting.shortcut})`;
                button.addEventListener('click', function() {
                    const cat = this.getAttribute('data-category');
                    classifyCurrentImage(cat);
                });
                controlsDiv.appendChild(button);
            });
            
            // é‡æ–°æ·»åŠ æ’¤é”€æŒ‰é’®
            if (undoButton) {
                controlsDiv.appendChild(undoButton);
            }
            
            // æ›´æ–°é”®ç›˜å¿«æ·é”®ç›‘å¬å™¨
            updateKeyboardShortcuts();
        }
        
        // æ›´æ–°é”®ç›˜å¿«æ·é”®ç›‘å¬å™¨
        function updateKeyboardShortcuts() {
            // ç§»é™¤æ—§çš„é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
            document.removeEventListener('keydown', handleKeyDownWithCustomShortcuts);
            
            // æ·»åŠ æ–°çš„é”®ç›˜äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('keydown', handleKeyDownWithCustomShortcuts);
        }
        
        // å¸¦è‡ªå®šä¹‰å¿«æ·é”®çš„é”®ç›˜äº‹ä»¶å¤„ç†
        function handleKeyDownWithCustomShortcuts(e) {
            // åªåœ¨ä»»åŠ¡ç•Œé¢å¯ç”¨å¿«æ·é”®
            if (taskSection.classList.contains('hidden')) return;
            
            const categoriesSettings = getCategoriesSettings();
            const enabledCategories = categoriesSettings.filter(cat => cat.enabled);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯è‡ªå®šä¹‰å¿«æ·é”®
            for (let i = 0; i < enabledCategories.length; i++) {
                if (e.key == enabledCategories[i].shortcut) {
                    classifyCurrentImage(enabledCategories[i].name);
                    return;
                }
            }
            
            // å¤„ç†å…¶ä»–å¿«æ·é”®
            switch(e.key) {
                case '+':
                case '=':
                    if (e.ctrlKey) zoomIn();
                    break;
                case '-':
                    if (e.ctrlKey) zoomOut();
                    break;
                case '0':
                    if (e.ctrlKey) resetView();
                    break;
                case 'z':
                case 'Z':
                    if (e.ctrlKey) undo();
                    break;
                case 'ArrowLeft':
                    offsetX += 40;
                    applyTransform();
                    break;
                case 'ArrowRight':
                    offsetX -= 40;
                    applyTransform();
                    break;
                case 'ArrowUp':
                    offsetY += 40;
                    applyTransform();
                    break;
                case 'ArrowDown':
                    offsetY -= 40;
                    applyTransform();
                    break;
            }
        }
    </script>
</body>
</html>